plugins {
    id 'java'
    id 'io.quarkus'
    id 'org.openapi.generator' version '7.10.0'
}

repositories {
    mavenCentral()
    mavenLocal()
}

dependencies {
    implementation enforcedPlatform("${quarkusPlatformGroupId}:${quarkusPlatformArtifactId}:${quarkusPlatformVersion}")
    implementation 'io.quarkus:quarkus-rest'
    implementation 'io.quarkus:quarkus-rest-client-jackson'
    implementation 'io.quarkus:quarkus-rest-jackson'
    implementation 'io.quarkus:quarkus-hibernate-orm-panache'
    implementation 'io.quarkus:quarkus-smallrye-health'
    implementation 'io.quarkus:quarkus-jdbc-postgresql'
    implementation 'io.quarkus:quarkus-micrometer'
    implementation 'io.quarkus:quarkus-arc'

    // Swagger UI / OpenAPI
    implementation 'io.quarkus:quarkus-smallrye-openapi'

    implementation 'org.mapstruct:mapstruct:1.6.3'

    // OpenAPI Generator dependencies
    implementation 'io.swagger.core.v3:swagger-annotations:2.2.26'
    implementation 'io.swagger:swagger-annotations:1.6.14'
    implementation 'org.openapitools:jackson-databind-nullable:0.2.6'
    implementation 'jakarta.validation:jakarta.validation-api:3.1.0'

    annotationProcessor 'org.mapstruct:mapstruct-processor:1.6.3'
    testImplementation 'io.quarkus:quarkus-junit5'
}

group = 'br.com.iagoomes'
version = '1.0.0-SNAPSHOT'

java {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
}

test {
    systemProperty "java.util.logging.manager", "org.jboss.logmanager.LogManager"
    jvmArgs "--add-opens", "java.base/java.lang=ALL-UNNAMED"
}
compileJava {
    options.encoding = 'UTF-8'
    options.compilerArgs << '-parameters'
}

compileTestJava {
    options.encoding = 'UTF-8'
}

// OpenAPI Generator configuration
def generatedSourcesDir = "${layout.buildDirectory.get()}/generated/openapi"

openApiGenerate {
    generatorName = "jaxrs-spec"
    inputSpec = "$rootDir/src/main/resources/openapi/openapi.yaml"
    outputDir = generatedSourcesDir
    apiPackage = "br.com.iagoomes.app.api"
    modelPackage = "br.com.iagoomes.app.api.model"
    invokerPackage = "br.com.iagoomes.app.api.invoker"

    configOptions = [
        // Padrão Delegate
        delegatePattern: "false",  // jaxrs-spec não suporta delegate completo como Spring

        // OpenAPI Nullable
        openApiNullable: "false",

        // Java/Date configuration
        java8: "false",
        dateLibrary: "java8",  // ou "java21" se preferir

        // Builders e Getters
        generateBuilders: "true",
        booleanGetterPrefix: "is",

        // Metadata
        hideGenerationTimestamp: "true",

        // Validation
        useBeanValidation: "true",
        performBeanValidation: "true",

        // Tags e Annotations
        useTags: "true",
        useSwaggerAnnotations: "true",

        // Response
        returnResponse: "true",

        // Jakarta EE (equivalente ao useSpringBoot3)
        useJakartaEe: "true",
        interfaceOnly: "true",

        // Serialization
        serializationLibrary: "jackson",

        // Build config
        sourceFolder: "src/main/java",
        implFolder: "src/main/java",
        generatePom: "false"
    ]

    // Anotações adicionais nos models (igual ao Spring)
    additionalProperties = [
        apiNameSuffix: "Api",
        additionalModelTypeAnnotations: """@SuppressWarnings({"hiding", "static-method", "unused"})
@com.fasterxml.jackson.annotation.JsonInclude(com.fasterxml.jackson.annotation.JsonInclude.Include.NON_NULL)"""
    ]

    // Type mappings (igual ao Spring)
    typeMappings = [
        DateTime: "java.time.LocalDateTime"
    ]

    importMappings = [
        "java.time.LocalDateTime": "java.time.LocalDateTime"
    ]

}

// Adiciona o código gerado ao sourceSets ANTES da configuração
sourceSets {
    main {
        java {
            srcDir "$generatedSourcesDir/src/main/java"
        }
    }
}

// Garante que a geração ocorra antes de processar os sources
tasks.named('compileJava') {
    dependsOn tasks.named('openApiGenerate')
}

tasks.named('processResources') {
    dependsOn tasks.named('openApiGenerate')
}

// Configuração do MapStruct para trabalhar com classes geradas
tasks.withType(JavaCompile).configureEach {
    options.annotationProcessorPath = configurations.annotationProcessor
}
